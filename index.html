<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧點名與公差管理系統</title>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts -->
    <!-- 導航列 -->
    <header class="app-header">
        <h1>智慧點名系統</h1>
        <div class="session-selector">
            <label for="sessionSelect">點名時段：</label>
            <select id="sessionSelect">
                <option value="早點名">早點名</option>
                <option value="早上餐廳">早上餐廳</option>
                <option value="早上教學區">早上教學區</option>
                <option value="中午餐廳">中午餐廳</option>
                <option value="下午教學區">下午教學區</option>
                <option value="晚上餐廳">晚上餐廳</option>
                <option value="晚自習">晚自習</option>
                <option value="晚點名">晚點名</option>
                <option value="軍訓1">軍訓1</option>
                <option value="軍訓2">軍訓2</option>
            </select>
        </div>
    </header>
    <nav class="main-nav">
        <button class="nav-tab active" data-tab="rollcall">點名操作</button>
        <button class="nav-tab" data-tab="settings">設定管理</button>
        <button class="nav-tab" data-tab="report">建置班報表</button>
        <button class="nav-tab" data-tab="group-report">組別報表</button>
        <button class="nav-tab" data-tab="import">智慧匯入</button>
    </nav>

    <main class="main-content-wrapper">

        <!-- 分頁 1: 點名操作 (Roll Call) -->
        <div id="tab-rollcall" class="tab-content active">
            <main class="main-content">
                <!-- 左側：人員管理面板 (僅顯示，不新增) -->
                <section class="panel people-panel">
                    <div class="panel-header">
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <h2>人員名單</h2>
                            <select id="unitFilter"
                                style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                                <option value="all">所有建置班</option>
                            </select>
                            <select id="groupFilter"
                                style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                                <option value="all">所有組別</option>
                            </select>
                        </div>
                        <div class="count-badge">無公差: <span id="unassignedCount">0</span></div>
                    </div>
                    <div class="people-list-container" id="unassignedList">
                        <!-- 無公差人員卡片將顯示於此 -->
                        <div class="empty-state">暫無人員</div>
                    </div>
                </section>

                <!-- 右側：公差分配區 -->
                <section class="panel duty-panel">
                    <div class="panel-header">
                        <h2>公差分配</h2>
                    </div>
                    <div class="duties-container" id="dutiesContainer">
                        <!-- 公差區塊將動態生成 -->
                    </div>
                </section>
            </main>
        </div>

        <!-- 設定管理面板 -->
        <div id="tab-settings" class="tab-content">
            <!-- 人員管理區塊 -->
            <div class="panel settings-container">
                <h2>設定管理</h2>
                <div class="settings-section">
                    <h3>新增/管理人員</h3>
                    <div class="input-stack">
                        <label>姓名</label>
                        <input type="text" id="newPersonName" placeholder="請輸入姓名">

                        <label>建置班</label>
                        <input type="text" id="newPersonUnit" placeholder="請輸入建置班 (例如: 一班)">

                        <label>組別</label>
                        <input type="text" id="newPersonGroup" placeholder="請輸入組別 (例如: 115一般)">

                        <button id="addPersonBtn" class="btn btn-primary" style="margin-top: 10px;">新增人員</button>
                    </div>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

                    <h4>批次新增人員</h4>
                    <div class="input-stack">
                        <textarea id="batchInput"
                            placeholder="請輸入人員資料，一行一位，格式：姓名 建置班 組別&#10;範例：&#10;王小明 一班 115一般&#10;李大華 二班 115發修" rows="5"
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        <button id="batchAddBtn" class="btn btn-secondary" style="margin-top: 5px;">批次匯入</button>
                    </div>

                    <h4>人員列表</h4>
                    <input type="text" id="settingSearchInput" placeholder="🔍 搜尋姓名、建置班或組別..."
                        style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    <div class="settings-list-header">
                        <span>姓名</span>
                        <span>建置班</span>
                        <span>組別</span>
                        <span>操作</span>
                    </div>
                    <div id="settingsPeopleList" class="settings-list">
                        <!-- 人員列表項目 -->
                    </div>
                </div>
            </div>

            <!-- 公差管理區塊 (獨立面板) -->
            <div class="panel settings-container" style="margin-top: 20px;">
                <div class="settings-section">
                    <h3>新增/管理公差</h3>
                    <div class="input-group">
                        <input type="text" id="newDutyInput" placeholder="新增公差名稱...">
                        <button id="addDutyBtn" class="btn btn-primary">新增公差</button>
                    </div>

                    <h4>公差列表</h4>
                    <div id="settingsDutyList" class="settings-list">
                        <!-- 公差列表項目 -->
                    </div>
                </div>
            </div>

            <!-- 系統操作區塊 (設定頁專屬) -->
            <div class="panel settings-container" style="margin-top: 20px;">
                <div class="settings-section"
                    style="padding: 10px 15px; margin: 0; display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
                    <h3 style="margin: 0; white-space: nowrap;">系統操作</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="resetAssignmentsBtn" class="btn"
                            style="background-color: #ff9800; color: white;">清除所有公差分配</button>
                        <button id="resetDataBtn" class="btn btn-danger">重置所有資料</button>
                        <button id="exportJSONBtn" class="btn btn-secondary">匯出備份 (JSON)</button>
                    </div>
                </div>
            </div>

        </div> <!-- 分頁 3: 建置班報表 (Report) -->
        <div id="tab-report" class="tab-content">
            <div class="report-container panel">
                <div class="panel-header" style="justify-content: space-between; display: flex;">
                    <h2>建置班統計報表</h2>
                    <button id="copyReportBtn" class="btn btn-success">複製報表文字</button>
                </div>

                <!-- 篩選建置班 -->
                <details class="accordion-filter" id="reportUnitFilter"
                    style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fff;">
                    <summary
                        style="padding: 10px; font-weight: bold; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between;">
                        <span>🔍 顯示建置班設定 <span id="reportFilterCount"
                                style="font-weight:normal; color:#666; font-size:0.9em;">(顯示全部)</span></span>
                        <span class="toggle-icon">▼</span>
                    </summary>
                    <div class="filter-content" style="padding: 10px; border-top: 1px solid #eee;">
                        <div class="filter-actions" style="margin-bottom: 10px; display: flex; gap: 10px;">
                            <button id="selectAllUnitsBtn" class="btn btn-sm"
                                style="padding: 4px 10px; font-size: 0.9em; background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;">全選</button>
                            <button id="clearAllUnitsBtn" class="btn btn-sm btn-outline"
                                style="padding: 4px 10px; font-size: 0.9em; background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">清空</button>
                        </div>
                        <div id="unitCheckboxes" class="checkbox-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">
                            <!-- Checkboxes will be injected here -->
                        </div>
                    </div>
                </details>

                <!-- 新增統計摘要 -->
                <div class="report-summary">
                    <div class="summary-card total">
                        <h3>應到</h3>
                        <span id="totalPeopleCount">0</span>
                    </div>
                    <div class="summary-card success">
                        <h3>實到</h3>
                        <span id="actualPeopleCount">0</span>
                    </div>
                    <div class="summary-card duty">
                        <h3>公差</h3>
                        <span id="totalDutyCount">0</span>
                    </div>
                </div>

                <!-- 公差細項總覽 -->
                <div id="globalDutyStats" class="duty-stats-bar">
                    <!-- 動態生成: 公差A: 3 | 公差B: 2 ... -->
                </div>

                <div id="reportContent" class="report-grid">
                    <!-- 報表內容 -->
                </div>

                <!-- 進階輸出區塊 -->
                <div class="advanced-export-section">
                    <h3>進階輸出：單一建置班全時段報表</h3>
                    <div class="advanced-export-controls">
                        <select id="exportUnitSelect">
                            <option value="">選擇建置班...</option>
                        </select>
                        <button id="copyUnitAllSessionBtn" class="btn btn-info"
                            style="background-color: #17a2b8; color: white;">複製全時段報表</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分頁 5: 智慧匯入 (Import) -->
        <div id="tab-import" class="tab-content">
            <div class="panel settings-container" style="max-width: 900px; margin: 0 auto;">
                <h2>智慧公差文字匯入</h2>
                <p>請貼上全日公差報表文字，系統將自動解析時段與公差分配。</p>

                <div class="import-step" id="importStep1">
                    <textarea id="smartImportText" placeholder="在此貼上報表文字...
範例：
早點名
應到7
業務3郭XX 李OO 徐YY
實到4
..." style="width: 100%; height: 300px; padding: 10px; font-family: monospace; font-size: 1.1em;"></textarea>
                    <div style="margin-top: 20px; text-align: right;">
                        <button id="analyzeImportBtn" class="btn btn-primary btn-lg">開始解析</button>
                    </div>
                </div>

                <div class="import-step hidden" id="importStep2">
                    <h3>解析預覽</h3>
                    <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                        <table class="report-table" id="importPreviewTable">
                            <thead>
                                <tr>
                                    <th>時段</th>
                                    <th>公差名稱</th>
                                    <th>人員</th>
                                    <th>狀態</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preview Rows -->
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
                        <span id="importSummaryText">共解析出 0 筆資料</span>
                        <div>
                            <button id="backToImportStep1Btn" class="btn btn-secondary">返回修改</button>
                            <button id="confirmImportBtn" class="btn btn-success">確認匯入</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分頁 4: 組別報表 (Group Report) -->
        <div id="tab-group-report" class="tab-content">
            <div class="report-container panel">
                <div class="panel-header" style="justify-content: space-between; display: flex;">
                    <h2>組別統計報表</h2>
                    <button id="copyGroupReportBtn" class="btn btn-success">複製報表文字</button>
                </div>

                <!-- 篩選組別 -->
                <details class="accordion-filter" id="reportGroupFilter"
                    style="margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fff;">
                    <summary
                        style="padding: 10px; font-weight: bold; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between;">
                        <span>🔍 顯示組別設定 <span id="groupFilterCount"
                                style="font-weight:normal; color:#666; font-size:0.9em;">(顯示全部)</span></span>
                        <span class="toggle-icon">▼</span>
                    </summary>
                    <div class="filter-content" style="padding: 10px; border-top: 1px solid #eee;">
                        <div class="filter-actions" style="margin-bottom: 10px; display: flex; gap: 10px;">
                            <button id="selectAllGroupsBtn" class="btn btn-sm"
                                style="padding: 4px 10px; font-size: 0.9em; background-color: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;">全選</button>
                            <button id="clearAllGroupsBtn" class="btn btn-sm btn-outline"
                                style="padding: 4px 10px; font-size: 0.9em; background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5;">清空</button>
                        </div>
                        <div id="groupCheckboxes" class="checkbox-grid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px;">
                            <!-- Checkboxes will be injected here -->
                        </div>
                    </div>
                </details>

                <!-- 統計摘要 -->
                <div class="report-summary">
                    <div class="summary-card total">
                        <h3>應到</h3>
                        <span id="groupTotalPeopleCount">0</span>
                    </div>
                    <div class="summary-card success">
                        <h3>實到</h3>
                        <span id="groupActualPeopleCount">0</span>
                    </div>
                    <div class="summary-card duty">
                        <h3>公差</h3>
                        <span id="groupTotalDutyCount">0</span>
                    </div>
                </div>

                <!-- 公差細項總覽 (Group) -->
                <div id="groupGlobalDutyStats" class="duty-stats-bar">
                    <!-- 動態生成: 公差A: 3 | 公差B: 2 ... -->
                </div>

                <div id="groupReportContent" class="report-grid">
                    <!-- 報表內容 -->
                </div>
            </div>
        </div>


    </main>
    </div>

    <!-- 匯總模態框 (Modal) - 保留舊有的一鍵匯總功能，或可整合進報表頁的複製功能 -->
    <!-- 暫時隱藏，改用報表頁取代 -->

    <footer style="text-align: center; padding: 10px; color: #666; font-size: 0.9em;">
        <div id="saveStatus">檢查連線中...</div>
    </footer>

    <!-- Config & Logic -->
    <!-- Firebase SDK (v8.10.1 Compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="firebase-config.js"></script>
    <script src="script.js?v=20260105_101"></script>
    </body>

</html>