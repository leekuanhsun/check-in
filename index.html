<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智慧點名與公差管理系統</title>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts -->
    <!-- 導航列 -->
    <header class="app-header">
        <h1>智慧點名系統</h1>
        <div class="session-selector">
            <label for="sessionSelect">點名時段：</label>
            <select id="sessionSelect">
                <option value="早點名">早點名</option>
                <option value="早上餐廳">早上餐廳</option>
                <option value="早上教學區">早上教學區</option>
                <option value="中午餐廳">中午餐廳</option>
                <option value="下午教學區">下午教學區</option>
                <option value="晚上餐廳">晚上餐廳</option>
                <option value="晚自習">晚自習</option>
                <option value="晚點名">晚點名</option>
                <option value="軍訓1">軍訓1</option>
                <option value="軍訓2">軍訓2</option>
            </select>
        </div>
    </header>
    <nav class="main-nav">
        <button class="nav-tab active" data-tab="rollcall">點名操作</button>
        <button class="nav-tab" data-tab="settings">設定管理</button>
        <button class="nav-tab" data-tab="report">建置班報表</button>
        <button class="nav-tab" data-tab="group-report">組別報表</button>
    </nav>

    <main class="main-content-wrapper">

        <!-- 分頁 1: 點名操作 (Roll Call) -->
        <div id="tab-rollcall" class="tab-content active">
            <main class="main-content">
                <!-- 左側：人員管理面板 (僅顯示，不新增) -->
                <section class="panel people-panel">
                    <div class="panel-header">
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <h2>人員名單</h2>
                            <select id="unitFilter"
                                style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                                <option value="all">所有建置班</option>
                            </select>
                            <select id="groupFilter"
                                style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                                <option value="all">所有組別</option>
                            </select>
                        </div>
                        <div class="count-badge">無公差: <span id="unassignedCount">0</span></div>
                    </div>
                    <div class="people-list-container" id="unassignedList">
                        <!-- 無公差人員卡片將顯示於此 -->
                        <div class="empty-state">暫無人員</div>
                    </div>
                </section>

                <!-- 右側：公差分配區 -->
                <section class="panel duty-panel">
                    <div class="panel-header">
                        <h2>公差分配</h2>
                    </div>
                    <div class="duties-container" id="dutiesContainer">
                        <!-- 公差區塊將動態生成 -->
                    </div>
                </section>
            </main>
        </div>

        <!-- 設定管理面板 -->
        <div id="tab-settings" class="tab-content">
            <!-- 人員管理區塊 -->
            <div class="panel settings-container">
                <h2>設定管理</h2>
                <div class="settings-section">
                    <h3>新增/管理人員</h3>
                    <div class="input-stack">
                        <label>姓名</label>
                        <input type="text" id="newPersonName" placeholder="請輸入姓名">

                        <label>建置班</label>
                        <input type="text" id="newPersonUnit" placeholder="請輸入建置班 (例如: 一班)">

                        <label>組別</label>
                        <input type="text" id="newPersonGroup" placeholder="請輸入組別 (例如: 115一般)">

                        <button id="addPersonBtn" class="btn btn-primary" style="margin-top: 10px;">新增人員</button>
                    </div>
                    <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

                    <h4>批次新增人員</h4>
                    <div class="input-stack">
                        <textarea id="batchInput"
                            placeholder="請輸入人員資料，一行一位，格式：姓名 建置班 組別&#10;範例：&#10;王小明 一班 115一般&#10;李大華 二班 115發修" rows="5"
                            style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        <button id="batchAddBtn" class="btn btn-secondary" style="margin-top: 5px;">批次匯入</button>
                    </div>

                    <h4>人員列表</h4>
                    <div class="settings-list-header">
                        <span>姓名</span>
                        <span>建置班</span>
                        <span>組別</span>
                        <span>操作</span>
                    </div>
                    <div id="settingsPeopleList" class="settings-list">
                        <!-- 人員列表項目 -->
                    </div>
                </div>
            </div>

            <!-- 公差管理區塊 (獨立面板) -->
            <div class="panel settings-container" style="margin-top: 20px;">
                <div class="settings-section">
                    <h3>新增/管理公差</h3>
                    <div class="input-group">
                        <input type="text" id="newDutyInput" placeholder="新增公差名稱...">
                        <button id="addDutyBtn" class="btn btn-primary">新增公差</button>
                    </div>

                    <h4>公差列表</h4>
                    <div id="settingsDutyList" class="settings-list">
                        <!-- 公差列表項目 -->
                    </div>
                </div>
            </div>

            <!-- 系統操作區塊 (獨立面板) -->
            <div class="panel settings-container" style="margin-top: 20px;">
                <div class="settings-section">
                    <h3>系統操作</h3>
                    <button id="resetDataBtn" class="btn btn-danger">重置所有資料</button>
                    <button id="exportJSONBtn" class="btn btn-secondary" style="margin-top: 10px;">匯出備份
                        (JSON)</button>
                </div>
            </div>
        </div>

        <!-- 分頁 3: 建置班報表 (Report) -->
        <div id="tab-report" class="tab-content">
            <div class="report-container panel">
                <div class="panel-header" style="justify-content: space-between; display: flex;">
                    <h2>建置班統計報表</h2>
                    <button id="copyReportBtn" class="btn btn-success">複製報表文字</button>
                </div>
                <!-- 新增統計摘要 -->
                <div class="report-summary">
                    <div class="summary-card total">
                        <h3>應到</h3>
                        <span id="totalPeopleCount">0</span>
                    </div>
                    <div class="summary-card success">
                        <h3>實到</h3>
                        <span id="actualPeopleCount">0</span>
                    </div>
                    <div class="summary-card duty">
                        <h3>公差</h3>
                        <span id="totalDutyCount">0</span>
                    </div>
                </div>

                <!-- 公差細項總覽 -->
                <div id="globalDutyStats" class="duty-stats-bar">
                    <!-- 動態生成: 公差A: 3 | 公差B: 2 ... -->
                </div>

                <div id="reportContent" class="report-grid">
                    <!-- 報表內容 -->
                </div>

                <!-- 進階輸出區塊 -->
                <div class="advanced-export-section">
                    <h3>進階輸出：單一建置班全時段報表</h3>
                    <div class="advanced-export-controls">
                        <select id="exportUnitSelect">
                            <option value="">選擇建置班...</option>
                        </select>
                        <button id="copyUnitAllSessionBtn" class="btn btn-info"
                            style="background-color: #17a2b8; color: white;">複製全時段報表</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 分頁 4: 組別報表 (Group Report) -->
        <div id="tab-group-report" class="tab-content">
            <div class="report-container panel">
                <div class="panel-header" style="justify-content: space-between; display: flex;">
                    <h2>組別統計報表</h2>
                    <button id="copyGroupReportBtn" class="btn btn-success">複製報表文字</button>
                </div>
                <!-- 統計摘要 -->
                <div class="report-summary">
                    <div class="summary-card total">
                        <h3>應到</h3>
                        <span id="groupTotalPeopleCount">0</span>
                    </div>
                    <div class="summary-card success">
                        <h3>實到</h3>
                        <span id="groupActualPeopleCount">0</span>
                    </div>
                    <div class="summary-card duty">
                        <h3>公差</h3>
                        <span id="groupTotalDutyCount">0</span>
                    </div>
                </div>

                <div id="groupReportContent" class="report-grid">
                    <!-- 報表內容 -->
                </div>
            </div>
        </div>

    </main>
    </div>

    <!-- 匯總模態框 (Modal) - 保留舊有的一鍵匯總功能，或可整合進報表頁的複製功能 -->
    <!-- 暫時隱藏，改用報表頁取代 -->

    <footer style="text-align: center; padding: 10px; color: #666; font-size: 0.9em;">
        <div id="saveStatus">檢查連線中...</div>
    </footer>

    <!-- Config & Logic -->
    <!-- Firebase SDK (v8.10.1 Compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="firebase-config.js"></script>
    <script src="script.js?v=20260105_55"></script>
    </body>

</html>